## `geometry.tcl` (CSF export) — detailed, block-by-block explanation

This file is **not meant to be sourced** as a complete OpenSees model.  
It is a **CSF data file**: it contains *station-by-station section properties* plus the **centroid offsets** needed by external builders to reconstruct a centroid axis.

The file is created by:

```python
write_opensees_geometry(section_field, n_points=10, filename=geometryfile)
```

Example (excerpt):

```tcl
# OpenSees Geometry DATA File - Generated by CSF
# Beam Span: 10.000000 (units follow your model)
# Stations: 10
# NOTE: This file is meant to be PARSED AS DATA (do NOT source it as Tcl).
# NOTE: Section lines append 'Cx Cy' as CSF-only fields (not OpenSees syntax).
#
# CSF_EXPORT_MODE: E=E_ref ; A/I/J are station-wise CSF results (already weighted)
# CSF_TORSION_SELECTION: J_eff = max(J_sv_cell, J_sv_wall) if any >0 else J_sv if >0 else ERROR
#
# CSF_Z_STATIONS: 0 ... 10

# Informational nodes (best-fit line through centroid offsets)
node 1 ...
node 2 ...

geomTransf Linear 1 1 0 0

section Elastic 1 ...  # torsion=J_sv
...
section Elastic 10 ... # torsion=J_sv
```

---

## 1) Header block (human hints + export contract)

```tcl
# OpenSees Geometry DATA File - Generated by CSF
# Beam Span: 10.000000 (units follow your model)
# Stations: 10
# NOTE: This file is meant to be PARSED AS DATA (do NOT source it as Tcl).
# NOTE: Section lines append 'Cx Cy' as CSF-only fields (not OpenSees syntax).
#
# CSF_EXPORT_MODE: E=E_ref ; A/I/J are station-wise CSF results (already weighted)
# CSF_TORSION_SELECTION: J_eff = max(J_sv_cell, J_sv_wall) if any >0 else J_sv if >0 else ERROR
```

- Pure comments (`# ...`).
- They communicate:
  - the beam span `L`,
  - the number of stations `N`,
  - that the file must be **parsed**, not **sourced**,
  - the **export contract** used by CSF, including the torsion selection policy.

**Critical clarification:**  
The `section Elastic ...` lines include **two extra fields at the far right**:
- `Cx Cy` = centroid offsets at that station, **CSF-only**, not OpenSees syntax.  
An external builder must parse them explicitly if eccentricity preservation is required.

---

## 2) CSF station coordinates block (for exact station placement)

```tcl
# CSF_Z_STATIONS: z0 z1 ... zN-1
```

- Comment, but **machine-readable** for an external builder.
- This is the list of **exact z-coordinates** of the exported stations.

If the export uses Gauss–Lobatto stationing, then (conceptually):

```text
z0 = 0
zN-1 = L
(interior stations are non-uniform and clustered near the ends)
```

**Why it matters:**  
Station locking makes the export deterministic. Recomputing stations differently changes the model.

---

## 3) Informational nodes (optional; not used for precision)

```tcl
node 1 x0 y0 z0
node 2 x1 y1 z1
```

These nodes are optional and **informational**:
- they may encode a reference axis or legacy data,
- they are kept for human readability or older scripts.

A robust builder should not rely on these lines to reconstruct station placement.  
Instead it should use:
- `CSF_Z_STATIONS` for station positions, and
- per-station `Cx Cy` for a centroid axis (if eccentricity preservation is required).

---

## 4) Local orientation (`geomTransf`)

```tcl
geomTransf Linear 1 vx vy vz
```

- Defines the geometric transformation tag `1`.
- `vx vy vz` is the “vecxz” vector used to orient local axes about the member axis.
- A builder can reuse this orientation to keep bending directions consistent.

---

## 5) Section station lines (the core data)

General format:

```tcl
section Elastic <secTag> <E> <A> <Iz> <Iy> <G> <J> <Cx> <Cy>  # torsion=<selected_key>
```

### Field meaning (exact)

- `section Elastic`  
  OpenSees elastic section definition.

- `<secTag>`  
  Unique section id for this station (typically `1..N`).

- `<E>`, `<G>`  
  Moduli written by the exporter. Their meaning depends on the export contract:
  - physical moduli (direct stiffness), or
  - reference moduli `E_ref, G_ref` (with modular properties).

- `<A>`  
  Area at station (units: `L^2`). In CSF export mode it may already be weighted/modular.

- `<Iz>`, `<Iy>`  
  Second moments at station (units: `L^4`), possibly already weighted/modular.

- `<J>`  
  Torsion constant used by OpenSees (torsional stiffness `G*J`).  
  In CSF export, this `J` slot receives a **single selected torsion constant** per station according to the header policy:
  - prefer thin-walled candidates via `max(J_sv_cell, J_sv_wall)` when available,
  - else fallback to `J_sv`,
  - else `ERROR`.
  The selected CSF key is written in the trailing comment `# torsion=<selected_key>`.

- `<Cx> <Cy>` (**CSF-only extension fields**)  
  Centroid offsets at the station (units: `L`).  
  These are appended at the far right and are **not** OpenSees syntax.  
  They are intended for a builder to place centroid-axis nodes.

### Interpretation

Each station line is a snapshot at `z_i`:
- stiffness properties sampled at `z_i`,
- centroid offsets sampled at `z_i`,
- one torsion constant selected for OpenSees.

The member can be described by the list:

```text
{ z_i, A_i, Iz_i, Iy_i, J_i, Cx_i, Cy_i }
```

---

## 6) Template-only OpenSees commands (commented out)

```tcl
# TEMPLATE ONLY ...
# beamIntegration ...
# element forceBeamColumn ...
```

- These are comments for humans only.
- A robust builder typically does not rely on these lines, because the builder must decide how to map:
  - the exported station set, and
  - the station-wise sections,
to the final OpenSees element/integration commands.

---

## 7) What an external builder typically does with this file (minimal contract)

A robust CSF → OpenSees builder typically:

1) If strict station placement is required: read `CSF_Z_STATIONS`  
   - enforce `N = (# stations) = (# section lines)`.

2) Read each `section Elastic ...` line  
   - extract `E, A, Iz, Iy, G, J` **and** the extra fields `Cx Cy`
   - optionally read `# torsion=<selected_key>` for traceability.

3) If eccentricity preservation is required: build
   - a **reference axis** (clean line for BCs/loads),
   - a **centroid axis** using `Cx Cy` at the exported stations,
   - a kinematic bridge (e.g. `rigidLink beam`) from reference to centroid nodes.

4) Choose an integration mapping, for example:
   - single element with `N`-point Gauss–Lobatto (only if `Cx,Cy` are constant and stations match Lobatto), or
   - segmented elements with 2-point endpoint sampling (if `Cx,Cy` vary and intermediate nodes are needed).
  
 OpenSees Geometry DATA File - Generated by CSF

 ```
# Beam Span: 10.000000 (units follow your model)
# Stations: 10
# NOTE: This file is meant to be PARSED AS DATA (do NOT source it as Tcl).
# NOTE: Section lines append 'Cx Cy' as CSF-only fields (not OpenSees syntax).
#
# CSF_EXPORT_MODE: E=E_ref ; A/I/J are station-wise CSF results (already weighted)
# CSF_TORSION_SELECTION: J_eff = max(J_sv_cell, J_sv_wall) if any >0 else J_sv if >0 else ERROR

# CSF_Z_STATIONS: 0 0.402330459168 1.30613067447 2.61037525095 4.17360521167 5.82639478833 7.38962474905 8.69386932553 9.59766954083 10

# Informational nodes (best-fit line through centroid offsets)
node 1 0 1.35332593178e-17 0
node 2 0 0.25 10

geomTransf Linear 1 1 0 0

section Elastic 1 1.000000e+00 3.600000e-01 4.320000e-02 2.700000e-03 5.000000e-01 4.590000e-02 0.000000e+00 0.000000e+00  # torsion=J_sv
section Elastic 2 1.000000e+00 3.539650e-01 4.106363e-02 2.654738e-03 5.000000e-01 4.371837e-02 0.000000e+00 1.005826e-02  # torsion=J_sv
section Elastic 3 1.000000e+00 3.404080e-01 3.652378e-02 2.553060e-03 5.000000e-01 3.907684e-02 0.000000e+00 3.265327e-02  # torsion=J_sv
section Elastic 4 1.000000e+00 3.208444e-01 3.058155e-02 2.406333e-03 5.000000e-01 3.298788e-02 0.000000e+00 6.525938e-02  # torsion=J_sv
section Elastic 5 1.000000e+00 2.973959e-01 2.435462e-02 2.230469e-03 5.000000e-01 2.658508e-02 0.000000e+00 1.043401e-01  # torsion=J_sv
section Elastic 6 1.000000e+00 2.726041e-01 1.875743e-02 2.044531e-03 5.000000e-01 2.080196e-02 0.000000e+00 1.456599e-01  # torsion=J_sv
section Elastic 7 1.000000e+00 2.491556e-01 1.432149e-02 1.868667e-03 5.000000e-01 1.619016e-02 0.000000e+00 1.847406e-01  # torsion=J_sv
section Elastic 8 1.000000e+00 2.295920e-01 1.120589e-02 1.721940e-03 5.000000e-01 1.292783e-02 0.000000e+00 2.173467e-01  # torsion=J_sv
section Elastic 9 1.000000e+00 2.160350e-01 9.335731e-03 1.620262e-03 5.000000e-01 1.095599e-02 0.000000e+00 2.399417e-01  # torsion=J_sv
section Elastic 10 1.000000e+00 2.100000e-01 8.575000e-03 1.575000e-03 5.000000e-01 1.015000e-02 0.000000e+00 2.500000e-01  # torsion=J_sv

```
