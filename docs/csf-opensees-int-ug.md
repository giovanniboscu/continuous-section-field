## `geometry.tcl` (CSF export) — detailed, block-by-block explanation

This file is **not meant to be sourced** as a complete OpenSees model.  
It is a **CSF data file**: it contains *station-by-station section properties* plus the **centroid offsets** needed by external builders to reconstruct a centroid axis.

The file is created by:

```python
write_opensees_geometry(section_field, n_points=10, filename=geometryfile)
```

Example:

```tcl
# OpenSees Geometry DATA File - Generated by CSF
# Beam Span: 10.000000 (units follow your model)
# Stations: 10
# NOTE: This file is meant to be PARSED AS DATA (do NOT source it as Tcl).
# NOTE: Section lines append 'Cx Cy' as CSF-only fields (not OpenSees syntax).
#
# CSF_EXPORT_MODE: E=E_ref ; A/I/J are station-wise CSF results (already weighted)
# CSF_TORSION_SELECTION: J_tors = (J_sv_wall>0) else (J_sv_cell>0) else (J>0) else ERROR

# CSF_Z_STATIONS: 0 0.402330459168 1.30613067447 2.61037525095 4.17360521167 5.82639478833 7.38962474905 8.69386932553 9.59766954083 10

# Informational nodes (best-fit line through centroid offsets)
node 1 0 1.35332593178e-17 0
node 2 0 0.25 10

geomTransf Linear 1 1 0 0

section Elastic 1 1.000000e+00 3.600000e-01 4.320000e-02 2.700000e-03 5.000000e-01 4.590000e-02 0.000000e+00 0.000000e+00
...
section Elastic 10 1.000000e+00 2.100000e-01 8.575000e-03 1.575000e-03 5.000000e-01 1.015000e-02 0.000000e+00 2.500000e-01

# TEMPLATE ONLY (the Python builder defines the actual integration)
# beamIntegration Lobatto 1 1 2 3 4 5 6 7 8 9 10 1
# element forceBeamColumn 1 1 2 1 1
```

---

## 1) Header block (human hints + export contract)

```tcl
# OpenSees Geometry DATA File - Generated by CSF
# Beam Length: 10.000000 (units follow your model)
# Stations: 10
# NOTE: This file is meant to be PARSED AS DATA (do NOT source it as Tcl).
# NOTE: Section lines append 'xc yc' as CSF-only fields (not OpenSees syntax).
#
# CSF_EXPORT_MODE: E=E_ref ; A/I/J are station-wise CSF results (already weighted)
# CSF_TORSION_SELECTION: J_tors = (J_sv_wall>0) else (J_sv_cell>0) else (J>0) else ERROR
```

- Pure comments (`# ...`).
- They communicate:
  - the beam length `L`,
  - the number of stations `N`,
  - that the file must be **parsed**, not **sourced**,
  - the **export contract** used by CSF.

**Critical clarification:**  
The `section Elastic ...` lines include **two extra fields at the far right**:
- `Cx Cy` = centroid offsets at that station, **CSF-only**, not OpenSees syntax.  
A robust builder must parse them explicitly.

---

## 2) CSF station coordinates block (for exact station placement)

```tcl
# CSF_Z_STATIONS: z0 z1 ... zN-1
```

- Comment, but **machine-readable** for an external builder.
- This is the list of **exact z-coordinates** of the exported stations.

If the export uses Gauss–Lobatto stationing, then (conceptually):

```text
z0 = 0
zN-1 = L
(interior stations are non-uniform and clustered near the ends)
```

**Why it matters:**  
Station locking makes the export deterministic. Recomputing stations differently changes the model.

---

## 3) Informational nodes (optional; not used for precision)

```tcl
node 1 x0 y0 z0
node 2 x1 y1 z1
```

These nodes are optional and **informational**:
- they may encode a reference axis or legacy data,
- they are kept for human readability or older scripts.

A robust builder should not rely on these lines to reconstruct station placement.  
Instead it should use:
- `CSF_Z_STATIONS` for station positions, and
- per-station `xc yc` for a centroid axis (if eccentricity preservation is required).

---

## 4) Local orientation (`geomTransf`)

```tcl
geomTransf Linear 1 vx vy vz
```

- Defines the geometric transformation tag `1`.
- `vx vy vz` is the “vecxz” vector used to orient local axes about the member axis.
- A builder can reuse this orientation to keep bending directions consistent.

---

## 5) Section station lines (the core data)

General format:

```tcl
section Elastic <secTag> <E> <A> <Iz> <Iy> <G> <J> <xc> <yc>
```

### Field meaning (exact)

- `section Elastic`  
  OpenSees elastic section definition.

- `<secTag>`  
  Unique section id for this station (typically `1..N`).

- `<E>`, `<G>`  
  Moduli written by the exporter. Their meaning depends on the export contract:
  - physical moduli (direct stiffness), or
  - reference moduli `E_ref, G_ref` (with modular properties).

- `<A>`  
  Area at station (units: `L^2`). In CSF export mode it may already be weighted/modular.

- `<Iz>`, `<Iy>`  
  Second moments at station (units: `L^4`), possibly already weighted/modular.

- `<J>`  
  Torsional constant used by OpenSees (torsional stiffness `G*J`).  
  In CSF the exporter may select `J` from multiple torsion paths (e.g. wall/cell/legacy), but **the file stores a single scalar** per station.

- `<xc> <yc>` (**CSF-only extension fields**)  
  Centroid offsets at the station (units: `L`).  
  These are appended at the far right and are **not** OpenSees syntax.  
  They are intended for a builder to place centroid-axis nodes.

### Interpretation

Each station line is a snapshot at `z_i`:
- stiffness properties sampled at `z_i`,
- centroid offsets sampled at `z_i`.

The member can be described by the list:

```text
{ z_i, A_i, Iz_i, Iy_i, J_i, xc_i, yc_i }
```

---

## 6) Template-only OpenSees commands (commented out)

```tcl
# TEMPLATE ONLY ...
# beamIntegration Lobatto ...
# element forceBeamColumn ...
```

- These are comments for humans only.
- A robust builder typically does not rely on these lines, because the builder must decide how to map:
  - the exported station set, and
  - the station-wise sections,
to the final OpenSees element/integration commands.

---

## 7) What an external builder typically does with this file (minimal contract)

A robust CSF → OpenSees builder typically:

1) If strict station placement is required: read `CSF_Z_STATIONS`  
   - enforce `N = (# stations) = (# section lines)`.

2) Read each `section Elastic ...` line  
   - extract `E, A, Iz, Iy, G, J` **and** the extra fields `xc yc`.

3) If eccentricity preservation is required: build
   - a **reference axis** (clean line for BCs/loads),
   - a **centroid axis** using `xc yc` at the exported stations,
   - a kinematic bridge (e.g. `rigidLink beam`) from reference to centroid nodes.

4) Choose an integration mapping, for example:
   - single element with `N`-point Gauss–Lobatto (only if `xc,yc` are constant and stations match Lobatto), or
   - segmented elements with 2-point endpoint sampling (if `xc,yc` vary and intermediate nodes are needed).
